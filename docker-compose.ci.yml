services:

  nominatim_ci:
    image: mediagis/nominatim:5.1
    volumes:
      - ./tests/integration/data/wellington.osm.pbf:/nominatim/data/wellington.osm.pbf
      - nominatim-data-ci:/var/lib/postgresql/15/main
    environment:
      PBF_PATH: /nominatim/data/wellington.osm.pbf
      IMPORT: 1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://nominatim_ci:8080/search?q=test&format=json&limit=1"]
      interval: 20s
      timeout: 5s
      retries: 10

  osrm_ci:
    image: osrm/osrm-backend
    container_name: osrm_ci
    volumes:
      - ./tests/integration/data:/data
    command: >
      /bin/bash -c "
        osrm-extract -p /opt/car.lua /data/wellington.osm.pbf &&
        osrm-partition /data/wellington.osrm &&
        osrm-customize /data/wellington.osrm &&
        osrm-routed --algorithm mld /data/wellington.osrm
      "
    healthcheck:
      test: ["CMD-SHELL", "until wget -qO- 'http://osrm_ci:5000/route/v1/driving/0,0;0,0?overview=false' | grep -q 'NoRoute'; do sleep 1; done"]
      interval: 10s
      timeout: 5s
      retries: 10


  mytravelapp_ci:
    build:
      context: .
      dockerfile: Dockerfile
    image: mytravelapp_ci:latest
    working_dir: /app
    volumes:
      - .:/app:cached
    depends_on:
      nominatim_ci:
        condition: service_healthy
      osrm_ci:
        condition: service_healthy
    environment:
      NODE_ENV: test
      OSRM_URL: http://osrm_ci:5000
      NOMINATIM_URL: http://nominatim_ci:8080
    command: tail -f /dev/null

volumes:
  nominatim-data-ci: {}