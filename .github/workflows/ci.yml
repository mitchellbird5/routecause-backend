name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  integration:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build || echo "No build step defined"

      - name: Cache Nominatim data
        uses: actions/cache@v4
        with:
          path: tests/integration/nominatim-data
          key: ${{ runner.os }}-nominatim-data-v1

      - name: Cache OSRM data
        uses: actions/cache@v4
        with:
          path: tests/integration/osrm-data
          key: ${{ runner.os }}-osrm-data-v1

      - name: Bootstrap Nominatim data if missing
        run: |
          if [ ! -f tests/integration/nominatim-data/PG_VERSION ]; then
            docker run --rm \
              -v $PWD/tests/integration/nominatim-data:/var/lib/postgresql/16/main \
              -v $PWD:/data \
              mediagis/nominatim:5.1 \
              sh -c "nominatim import"
          fi

      - name: Bootstrap OSRM data if missing
        run: |
          if [ ! -f tests/integration/osrm-data/monaco.osrm ]; then
            docker run --rm \
              -v $PWD/tests/integration/osrm-data:/data/osrm \
              -v $PWD:/data \
              osrm/osrm-backend osrm-extract /data/monaco-latest.osm.pbf
          fi

      - name: Start CI containers
        run: docker compose -f docker-compose.ci.yml up -d

      - name: Run tests
        run: docker compose exec -T mytravelapp_ci npx jest --verbose

      - name: Tear down CI containers
        if: always()
        run: docker compose -f docker-compose.ci.yml down -v
